[build]
  command = "npm run build"
  publish = ".next"
  functions = "netlify/functions"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[build.environment]
  NEXT_TELEMETRY_DISABLED = "1"
  NODE_VERSION = "20"

# Netlify Functions設定
[functions]
  node_bundler = "esbuild"
  directory = "netlify/functions"

# Background Function - バッチスクレイピング用（最大15分）
[functions."scrape-background"]
  type = "background"

# Background Function - バッチシミュレーション用（最大15分）
[functions."simulate-background"]
  type = "background"

# Scheduled Functions
# 初回取得中: 毎時実行でコツコツ取得
# 完了後: 週1回（日曜0時）に差分スクレイプ
[functions."scheduled-scrape"]
  schedule = "0 * * * *"  # 毎時実行（初回取得用）

[functions."scheduled-scrape-weekly"]
  schedule = "0 0 * * 0"  # 毎週日曜0時（差分スクレイプ用）

[functions."scheduled-simulate"]
  schedule = "30 * * * *"  # 毎時30分（スクレイプ後に実行）

[functions."scheduled-check-links"]
  schedule = "0 3 * * 0"  # 毎週日曜3時（リンク切れチェック）

# Next.jsのAPIルートは@netlify/plugin-nextjsが自動処理するため
# /api/* へのリダイレクトは不要

# Background Functionへの直接アクセスを許可
[[redirects]]
  from = "/.netlify/functions/*"
  to = "/.netlify/functions/:splat"
  status = 200# 環境変数プレースホルダー（Netlify UIで設定）
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# SUPABASE_SERVICE_ROLE_KEY
# SLACK_WEBHOOK_URL
# ADMIN_TRIGGER_TOKEN
